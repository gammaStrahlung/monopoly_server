


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > MonopolyMessageHandler</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">at.gammastrahlung.monopoly_server.network.websocket</a>
</div>

<h1>Coverage Summary for Class: MonopolyMessageHandler (at.gammastrahlung.monopoly_server.network.websocket)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">MonopolyMessageHandler</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/54)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package at.gammastrahlung.monopoly_server.network.websocket;
&nbsp;
&nbsp;import at.gammastrahlung.monopoly_server.game.Game;
&nbsp;import at.gammastrahlung.monopoly_server.game.Player;
&nbsp;import at.gammastrahlung.monopoly_server.game.WebSocketPlayer;
&nbsp;import at.gammastrahlung.monopoly_server.network.dtos.ClientMessage;
&nbsp;import at.gammastrahlung.monopoly_server.network.dtos.ServerMessage;
&nbsp;import com.google.gson.Gson;
&nbsp;import com.google.gson.GsonBuilder;
&nbsp;import org.springframework.web.socket.WebSocketSession;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;
<b class="nc">&nbsp;public class MonopolyMessageHandler {</b>
&nbsp;
<b class="nc">&nbsp;    private static final Gson gson =  new GsonBuilder().setPrettyPrinting().excludeFieldsWithoutExposeAnnotation().create();</b>
&nbsp;
&nbsp;    public static void handleMessage(ClientMessage clientMessage, WebSocketSession session) {
&nbsp;        ServerMessage response;
&nbsp;
<b class="nc">&nbsp;        List&lt;Player&gt; recievers = new ArrayList&lt;&gt;();</b>
&nbsp;
&nbsp;        // Set player to player from server if it exists
<b class="nc">&nbsp;        WebSocketPlayer p = WebSocketPlayer.getPlayerByWebSocketSessionID(session.getId());</b>
<b class="nc">&nbsp;        if (p != null)</b>
<b class="nc">&nbsp;            clientMessage.setPlayer(p);</b>
&nbsp;
<b class="nc">&nbsp;        Game currentGame = clientMessage.getPlayer().getCurrentGame();</b>
<b class="nc">&nbsp;        if (currentGame != null)</b>
<b class="nc">&nbsp;            recievers.addAll(currentGame.getPlayers());</b>
&nbsp;        else
<b class="nc">&nbsp;            recievers.add(clientMessage.getPlayer());</b>
&nbsp;
&nbsp;        // Call the different Message Handlers
&nbsp;        try {
<b class="nc">&nbsp;            response = switch (clientMessage.getMessagePath()) {</b>
&nbsp;                case &quot;create&quot; -&gt; {
<b class="nc">&nbsp;                    clientMessage.getPlayer().setWebSocketSession(session); // Needed for player WebSocketSession tracking</b>
<b class="nc">&nbsp;                    yield createGame(clientMessage.getPlayer());</b>
&nbsp;                }
&nbsp;                case &quot;join&quot; -&gt; {
<b class="nc">&nbsp;                    clientMessage.getPlayer().setWebSocketSession(session); // Needed for player WebSocketSession tracking</b>
<b class="nc">&nbsp;                    var message = joinGame(Integer.parseInt(clientMessage.getMessage()), clientMessage.getPlayer());</b>
&nbsp;
&nbsp;                    // Update recievers to all players
<b class="nc">&nbsp;                    recievers.clear();</b>
<b class="nc">&nbsp;                    recievers.addAll(clientMessage.getPlayer().getCurrentGame().getPlayers());</b>
<b class="nc">&nbsp;                    yield message;</b>
&nbsp;                }
<b class="nc">&nbsp;                case &quot;players&quot; -&gt; getPlayers(clientMessage.getPlayer());</b>
<b class="nc">&nbsp;                case &quot;start&quot; -&gt; startGame(WebSocketPlayer.getPlayerByWebSocketSessionID(session.getId()));</b>
<b class="nc">&nbsp;                case &quot;end&quot; -&gt; endGame(WebSocketPlayer.getPlayerByWebSocketSessionID(session.getId()));</b>
<b class="nc">&nbsp;                default -&gt; throw new IllegalArgumentException(&quot;Invalid MessagePath&quot;);</b>
&nbsp;            };
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            response = ServerMessage.builder()</b>
<b class="nc">&nbsp;                    .messagePath(clientMessage.getMessagePath())</b>
<b class="nc">&nbsp;                    .player(clientMessage.getPlayer())</b>
<b class="nc">&nbsp;                    .message(e.getMessage())</b>
<b class="nc">&nbsp;                    .type(ServerMessage.MessageType.ERROR)</b>
<b class="nc">&nbsp;                    .build();</b>
&nbsp;
<b class="nc">&nbsp;            WebSocketSender.sendToPlayer(session, response);</b>
&nbsp;            return;
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        WebSocketSender.sendToPlayers(response, recievers);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Called by the client to create a new game.
&nbsp;     *
&nbsp;     * @param player The player creating the game
&nbsp;     * @return ServerMessage that contains the GameId, that can be used by other clients to join the game.
&nbsp;     */
&nbsp;    public static ServerMessage createGame(WebSocketPlayer player) {
&nbsp;
&nbsp;        // Create a new game
<b class="nc">&nbsp;        Game game = new Game();</b>
&nbsp;
&nbsp;        // Player that creates the game should also join the game
<b class="nc">&nbsp;        game.join(player);</b>
&nbsp;
<b class="nc">&nbsp;        return new ServerMessage(&quot;create&quot;,</b>
&nbsp;                ServerMessage.MessageType.SUCCESS,
<b class="nc">&nbsp;                String.valueOf(game.getGameId()), player, game);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Called by the client to join a new game or to re-join after connection loss.
&nbsp;     *
&nbsp;     * @param gameId The gameId of the game, the player wants to join
&nbsp;     * @param player The player that wants to join the game.
&nbsp;     * @return ServerMessage with MessageType SUCCESS containing the GameId as the Message if joining was successful,
&nbsp;     * else ServerMessage has MessageType ERROR.
&nbsp;     */
&nbsp;    public static ServerMessage joinGame(int gameId, WebSocketPlayer player) {
&nbsp;
&nbsp;        // Try to join the game
<b class="nc">&nbsp;        Game game = Game.joinByGameId(gameId, player);</b>
&nbsp;
&nbsp;        // Joining the game was unsuccessful
<b class="nc">&nbsp;        if (game == null)</b>
<b class="nc">&nbsp;            return new ServerMessage(&quot;join&quot;, ServerMessage.MessageType.ERROR, &quot;&quot;, player, null);</b>
&nbsp;
<b class="nc">&nbsp;        return new ServerMessage(&quot;join&quot;,</b>
&nbsp;                ServerMessage.MessageType.SUCCESS,
<b class="nc">&nbsp;                String.valueOf(game.getGameId()), player, game);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns all Players playing the same game as the client.
&nbsp;     *
&nbsp;     * @param player The player calling.
&nbsp;     * @return ServerMessage containing an array of Players.
&nbsp;     */
&nbsp;    public static ServerMessage getPlayers(WebSocketPlayer player) {
&nbsp;        try {
<b class="nc">&nbsp;            var players = player.getCurrentGame().getPlayers().toArray();</b>
&nbsp;
<b class="nc">&nbsp;            return new ServerMessage(&quot;players&quot;,</b>
&nbsp;                    ServerMessage.MessageType.SUCCESS,
<b class="nc">&nbsp;                    gson.toJson(players),</b>
&nbsp;                    player, null);
&nbsp;
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            return new ServerMessage(&quot;players&quot;,</b>
&nbsp;                    ServerMessage.MessageType.ERROR,
&nbsp;                    &quot;&quot;,
&nbsp;                    player, null);
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Called by the client to start the current game
&nbsp;     *
&nbsp;     * @param player The player that wants to start the game.
&nbsp;     * @return ServerMessage with MessageType SUCCESS as the Message if starting the game was successful,
&nbsp;     * else ServerMessage has MessageType ERROR.
&nbsp;     */
&nbsp;    public static ServerMessage startGame(WebSocketPlayer player) {
<b class="nc">&nbsp;        Game game = player.getCurrentGame();</b>
&nbsp;
<b class="nc">&nbsp;        if (game.startGame(player)) {</b>
<b class="nc">&nbsp;            return new ServerMessage(&quot;start&quot;,</b>
&nbsp;                    ServerMessage.MessageType.SUCCESS,
&nbsp;                    &quot;&quot;,
&nbsp;                    player,
&nbsp;                    game);
&nbsp;        } else {
<b class="nc">&nbsp;            return new ServerMessage(&quot;start&quot;,</b>
&nbsp;                    ServerMessage.MessageType.ERROR,
&nbsp;                    &quot;&quot;,
&nbsp;                    player,
&nbsp;                    game);
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Called by the client to end the current game
&nbsp;     *
&nbsp;     * @param player The player that wants to end the game.
&nbsp;     * @return ServerMessage with MessageType SUCCESS as the Message if ending the game was successful,
&nbsp;     * else ServerMessage has MessageType ERROR.
&nbsp;     */
&nbsp;    public static ServerMessage endGame(WebSocketPlayer player) {
<b class="nc">&nbsp;        Game game = player.getCurrentGame();</b>
&nbsp;
<b class="nc">&nbsp;        if (game.endGame(player)) {</b>
<b class="nc">&nbsp;            return new ServerMessage(&quot;end&quot;,</b>
&nbsp;                    ServerMessage.MessageType.SUCCESS,
&nbsp;                    &quot;&quot;,
&nbsp;                    player,
&nbsp;                    game);
&nbsp;        } else {
<b class="nc">&nbsp;            return new ServerMessage(&quot;end&quot;,</b>
&nbsp;                    ServerMessage.MessageType.ERROR,
&nbsp;                    &quot;&quot;,
&nbsp;                    player,
&nbsp;                    game);
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-05-02 01:13</div>
</div>
</body>
</html>
